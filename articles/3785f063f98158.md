---
title: "Xymonã®Enable/Disableæ©Ÿèƒ½ãŒãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ç’°å¢ƒã§ä½¿ãˆãªã„ã®ã‚’ç›´ã™"
emoji: "ğŸ¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Xymon"]
published: true
published_at: 2020-04-26 21:32
---
Xymonã«ã¯Enable/Disable ã¨ã„ã†ç›£è¦–ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ãŒã€ãã‚ŒãŒä½¿ãˆãªããªã‚‹äº‹è±¡ãŒã‚ã‚Šã¾ã—ãŸã€‚
AmazonLinux 2ç’°å¢ƒã®Xymon 4.3.30ã€‚
Enable/Disableç”»é¢ã® Select what to Disable ã§ã€ŒApplyã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ã€ãªã«ã‚‚åå¿œãŒã‚ã‚Šã¾ã›ã‚“ã€‚
 
ã“ã®ã¨ã Apache ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ã¯
```log
AH01215: æ—¥ä»˜ Enadis POST that is not coming from self or svcstatus (referer=http://example.com/xymon-seccgi/enadis.sh). Ignoring.: /home/xymon/cgi-secure/enadis.sh, referer: http://example.com/xymon-seccgi/enadis.sh
```
ã¨ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚
Enadisã¨ã¯Enable/Disableã®ç•¥ã§ã™ã­ã€‚POSTã¯httpã®POSTã®ã“ã¨ã§ã¯ãªãæŠ•ç¨¿ã¨ã®æ„å‘³ã€‚
Enable/Disableã®æŠ•ç¨¿ã¯è‡ªåˆ†è‡ªèº«ã‹svcstatusã‹ã‚‰ã¯è¨±å¯ã•ã‚Œã¦ã„ãªã„ã¨ã®ã“ã¨ã§ã™ã€‚
ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ã£ã¦è»¢é€ã—ã¦ã„ã‚‹ç’°å¢ƒãªã®ã§ä½¿ãˆãªã„ã¨å‡ºã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
 
å…¬å¼ãƒ¡ãƒ¼ãƒªãƒ³ã‚°ãƒªã‚¹ãƒˆã‚’æ¢ã™ã¨ 2019å¹´9æœˆ12æ—¥ ã« RenÃ© Vermareã•ã‚“ã‹ã‚‰ãƒ‘ãƒƒãƒã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã—ãŸã€‚
https://lists.xymon.com/archive/2019-September/046708.html ã‹ã‚‰å¼•ç”¨ã€‚
```diff
--- a/web/enadis.c      2019-07-23 17:29:06.000000000 +0200
+++ b/web/enadis.c      2019-09-11 01:06:33.283642013 +0200
@@ -332,7 +332,8 @@
    int argi, i;
    char *username = getenv("REMOTE_USER");
    char *userhost = getenv("REMOTE_HOST");
-    char *userip   = getenv("REMOTE_ADDR");
+    char *userip   = getenv("HTTP_X_FORWARDED_FOR");
+    if (userip == NULL) userip = getenv("REMOTE_ADDR");
    SBUF_DEFINE(fullmsg);
    char *envarea = NULL;
    int  obeycookies = 1;
--- a/web/acknowledge.c 2019-07-23 17:29:06.000000000 +0200
+++ b/web/acknowledge.c 2019-09-11 01:01:55.493676233 +0200
@@ -374,7 +374,8 @@
 
    parse_query();
        if (getenv("REMOTE_USER")) {
-            char *remaddr = getenv("REMOTE_ADDR");
+            char *remaddr = getenv("HTTP_X_FORWARDED_FOR");
+            if (remaddr == NULL) remaddr = getenv("REMOTE_ADDR");
 
            SBUF_MALLOC(acking_user, 1024 + strlen(getenv("REMOTE_USER")) + (remaddr ? strlen(remaddr) : 0));
            snprintf(acking_user, acking_user_buflen, "\nAcked by: %s", getenv("REMOTE_USER"));
```
 
å¤‰æ›´ç‚¹ã‚’è¦‹ã¦ã‚‚ã‚‰ãˆã°ã‚ã‹ã‚Šã¾ã™ãŒã€REMOTE_ADDRã§IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‹¾ã£ã¦ã„ã‚‹ã¨ã“ã‚ã‚’HTTP_X_FORWARDED_FORã‹ã‚‰æ‹¾ã†ã‚ˆã†ã«å¤‰ãˆã¦ã„ã¾ã™ã€‚ã“ã‚Œã§è‰¯ã•ãã†ã§ã™ã€‚

ãƒ•ãƒ­ãƒ³ãƒˆã®ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’Apacheã§ã‚„ã£ã¦ã„ã‚‹å ´åˆã¯ã€
```apacheconf
ProxyPreserveHost on
```
ã§è»¢é€å…ˆã«ãƒ›ã‚¹ãƒˆåã‚’é€ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
 
ã“ã®ãƒ‘ãƒƒãƒã‚’ã‚½ãƒ¼ã‚¹ã®ç›´ä¸‹ã«ç½®ã„ã¦ã€reverse_proxy.patchã¨ã‹é©å½“ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã¤ã‘ã¦ä¿å­˜ã€‚
```sh
patch -p1 < reverse_proxy.patch
```
ã§é©å¿œã—ãŸã‚‰ã€ã‚ã¨ã¯ãƒ“ãƒ«ãƒ‰ã—ç›´ã—ã¾ã™ã€‚
 
ã“ã‚Œã§è§£æ±ºã—ã¾ã—ãŸã€‚
